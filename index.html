<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EDU CONNECT</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
        rel="stylesheet" 
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" 
        crossorigin="anonymous">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- FirebaseUI CSS -->
  <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/firebaseui@6.0.2/dist/firebaseui.css">
  <style>
    :root {
      --primary-color: #405DE6;
      --secondary-color: #5851DB;
      --accent-color: #833AB4;
      --danger-color: #FD1D1D;
      --warning-color: #F56040;
      --success-color: #FCAF45;
    }
    
    body {
      background-color: #fafafa;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    
    .navbar {
      border-bottom: 1px solid #dbdbdb;
      background-color: white;
    }
    
    .navbar-brand {
      font-family: 'Billabong', cursive;
      font-size: 1.8rem;
      color: #262626 !important;
    }
    
    .profile-img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid white;
    }
    
    .cover-img {
      height: 300px;
      object-fit: cover;
    }
    
    .nav-tabs .nav-link.active {
      font-weight: bold;
      border: none;
      border-bottom: 2px solid var(--primary-color);
      color: #262626 !important;
    }
    
    .nav-tabs .nav-link {
      color: #8e8e8e;
      border: none;
    }
    
    .post-image {
      width: 100%;
      height: auto;
      max-height: 600px;
      object-fit: contain;
    }
    
    .feed-container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .post-card {
      background-color: white;
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    
    .post-header {
      padding: 14px 16px;
      border-bottom: 1px solid #efefef;
    }
    
    .post-actions {
      padding: 6px 16px;
    }
    
    .post-likes {
      padding: 0 16px;
      font-weight: bold;
    }
    
    .post-caption {
      padding: 0 16px 8px;
    }
    
    .post-comments {
      padding: 0 16px 8px;
      color: #8e8e8e;
    }
    
    .post-time {
      padding: 0 16px 12px;
      font-size: 10px;
      color: #8e8e8e;
      text-transform: uppercase;
    }
    
    .search-container {
      position: sticky;
      top: 20px;
    }
    
    .search-card {
      background-color: white;
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .suggestions-card {
      background-color: white;
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      padding: 8px 16px;
    }
    
    .suggestion-item {
      padding: 8px 0;
    }
    
    .story-circle {
      width: 66px;
      height: 66px;
      border-radius: 50%;
      padding: 2px;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
    }
    
    .story-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px solid white;
      overflow: hidden;
    }
    
    .story-username {
      font-size: 12px;
      text-align: center;
      margin-top: 4px;
      width: 66px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .stories-container {
      background-color: white;
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .story-item {
      display: inline-block;
      margin-right: 16px;
      vertical-align: top;
    }
    
    .certificate-card {
      transition: transform 0.2s;
    }
    
    .certificate-card:hover {
      transform: scale(1.03);
    }
    
    #firebaseui-auth-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }
    
    .firebaseui-container {
      max-width: 400px;
      width: 100%;
    }
    
    @media (max-width: 768px) {
      .search-container {
        display: none;
      }
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      height: 4px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 2px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* Loading spinner */
    .spinner-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100px;
    }
    
    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <!-- Toast Notifications -->
  <div class="toast-container">
    <div id="toast" class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMessage"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-light sticky-top">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-camera-retro me-1"></i> EDU Connect
      </a>
      <div class="d-flex">
        <a href="#" class="mx-3 text-dark" id="homeBtn">
          <i class="fas fa-home fa-lg"></i>
        </a>
        <a href="#" class="mx-3 text-dark" id="createBtn">
          <i class="far fa-square-plus fa-lg"></i>
        </a>
        <a href="#" class="mx-3 text-dark" id="profileBtn" data-bs-toggle="modal" data-bs-target="#profileModal">
          <i class="far fa-user fa-lg"></i>
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-4">
    <div class="row">
      <!-- Feed Column -->
      <div class="col-lg-8">
        <!-- Stories -->
        <div class="stories-container mb-4">
          <div class="story-item">
            <div class="story-circle">
              <div class="story-inner">
                <img src="https://via.placeholder.com/64" class="img-fluid" alt="Story">
              </div>
            </div>
            <div class="story-username">Your Story</div>
          </div>
          <!-- Stories will be dynamically inserted here -->
        </div>
        
        <!-- Feed Posts -->
        <div id="feedPosts">
          <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Search Column -->
      <div class="col-lg-4">
        <div class="search-container">
          <!-- Search Bar -->
          <div class="search-card mb-4">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="Search">
              <button class="btn btn-outline-secondary" id="searchBtn">
                <i class="fas fa-search"></i>
              </button>
            </div>
            <div id="searchResults" class="mt-3">
              <!-- Search results will appear here -->
            </div>
          </div>
          
          <!-- Suggestions -->
          <div class="suggestions-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="text-muted fw-bold">Suggestions For You</span>
              <a href="#" class="text-dark">See All</a>
            </div>
            <div id="suggestionsList">
              <!-- Suggestions will be dynamically inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content p-0">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="profileModalLabel"><i class="fas fa-user-circle me-2"></i>Your Profile</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <!-- Authentication Status Section -->
          <div id="authStatus" class="text-end p-2 bg-light">
            <span id="userEmail" class="me-2"></span>
            <button id="logoutBtn" class="btn btn-danger btn-sm d-none">
              <i class="fas fa-sign-out-alt me-1"></i> Logout
            </button>
            <button id="loginBtn" class="btn btn-primary btn-sm">
              <i class="fas fa-sign-in-alt me-1"></i> Login
            </button>
          </div>

          <div class="card overflow-hidden border-0">
            <div class="card-body p-0">
              <div class="position-relative">
                <img src="https://via.placeholder.com/1200x400" alt="Cover" class="img-fluid w-100 cover-img" id="coverImage">
                <!-- Cover Photo Edit Button -->
                <button class="btn btn-sm btn-light position-absolute top-0 end-0 m-2" id="editCoverBtn">
                  <i class="fas fa-camera"></i>
                </button>
              </div>

              <div class="row align-items-center">
                <div class="col-lg-4 text-center py-3">
                  <div class="d-flex justify-content-around">
                    <div>
                      <div class="fs-5 fw-bold" id="postCount">0</div>
                      <small>Posts</small>
                    </div>
                    <div>
                      <div class="fs-5 fw-bold" id="followerCount">0</div>
                      <small>Followers</small>
                    </div>
                    <div>
                      <div class="fs-5 fw-bold" id="followingCount">0</div>
                      <small>Following</small>
                    </div>
                  </div>
                </div>

                <div class="col-lg-4 text-center mt-n4 position-relative">
                  <div class="position-relative d-inline-block">
                    <div class="border border-4 border-white rounded-circle overflow-hidden">
                      <img id="profileImage" src="https://via.placeholder.com/150" alt="Profile" class="profile-img">
                    </div>
                    <!-- Profile Picture Edit Button -->
                    <button class="btn btn-sm btn-primary position-absolute bottom-0 end-0 rounded-circle" id="editProfilePicBtn">
                      <i class="fas fa-pencil-alt"></i>
                    </button>
                  </div>
                  <h5 class="mt-2 mb-0" id="userName">Loading...</h5>
                  <small id="userTitle">Member</small>
                </div>

                <div class="col-lg-4 text-center py-3">
                  <button class="btn btn-primary follow-btn" id="followBtn" style="display: none;">
                    Follow
                  </button>
                  <div class="d-flex justify-content-center gap-2 mt-2">
                    <a href="#" class="btn btn-primary btn-sm rounded-circle"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="btn btn-danger btn-sm rounded-circle"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="btn btn-dark btn-sm rounded-circle"><i class="fab fa-linkedin-in"></i></a>
                  </div>
                </div>

                <ul class="nav nav-tabs justify-content-center mt-2" id="profileTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-content" type="button">
                      <i class="fas fa-user me-1"></i> Profile
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts-content" type="button">
                      <i class="fas fa-image me-1"></i> Posts
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="certificates-tab" data-bs-toggle="tab" data-bs-target="#certificates-content" type="button">
                      <i class="fas fa-certificate me-1"></i> Certificates
                    </button>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="tab-content">
            <div class="tab-pane fade show active" id="profile-content" role="tabpanel">
              <div class="row p-3">
                <div class="col-md-4">
                  <div class="card mb-3">
                    <div class="card-body">
                      <h6>Introduction</h6>
                      <p class="small" id="userBio">Loading...</p>

                      <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                          <i class="fas fa-briefcase me-2"></i>
                          <span id="userEducation">Loading...</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                          <i class="fas fa-envelope me-2"></i>
                          <span id="userEmailDisplay">Loading...</span>
                        </div>
                        <div class="d-flex align-items-center">
                          <i class="fas fa-map-marker-alt me-2"></i>
                          <span id="userLocation">Loading...</span>
                        </div>
                      </div>

                      <div id="posts-section">
                        <h6><i class="fas fa-images me-1"></i> My Posts</h6>
                        <div class="row g-2 mt-2" id="recentPosts">
                          <!-- Recent posts will be dynamically inserted here -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-8">
                  <div class="card mb-3">
                    <div class="card-body">
                      <textarea class="form-control mb-2" id="postContent" placeholder="Share your thoughts..." rows="3"></textarea>
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <input type="file" id="postImageUpload" accept="image/*" class="d-none">
                          <button class="btn btn-outline-secondary btn-sm" id="uploadImageBtn">
                            <i class="fas fa-image me-1"></i> Add Image
                          </button>
                          <span id="imageName" class="ms-2 small text-muted"></span>
                        </div>
                        <button class="btn btn-primary btn-sm" id="postUpdateBtn">Post Update</button>
                      </div>
                    </div>
                  </div>

                  <div id="certificates-section">
                    <div class="card">
                      <div class="card-body">
                        <h6><i class="fas fa-certificate me-1"></i> My Certificates</h6>
                        <div class="row g-3 mt-2" id="certificatesList">
                          <!-- Certificates will be dynamically inserted here -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="posts-content" role="tabpanel">
              <div class="p-3">
                <div class="card">
                  <div class="card-body">
                    <h5><i class="fas fa-images me-2"></i>My Posts</h5>
                    <div class="row g-2" id="allPosts">
                      <!-- All posts will be dynamically inserted here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="certificates-content" role="tabpanel">
              <div class="p-3">
                <div class="card">
                  <div class="card-body">
                    <h5><i class="fas fa-certificate me-2"></i>My Certificates</h5>
                    <div class="row g-3" id="allCertificates">
                      <!-- All certificates will be dynamically inserted here -->
                    </div>
                    <div class="mt-3">
                      <input type="file" id="certificateUpload" accept="image/*" class="d-none">
                      <button class="btn btn-primary btn-sm" id="addCertificateBtn">
                        <i class="fas fa-plus me-1"></i> Add Certificate
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card m-3">
            <div class="card-body text-center">
              <h5><i class="fas fa-globe text-danger me-2"></i>Portfolio Webpage</h5>
              <p class="small mb-3">Showcase your complete profile, projects, and achievements online.</p>
              <a href="#" target="_blank" class="btn btn-danger">
                <i class="fas fa-external-link-alt me-1"></i> Open Portfolio
              </a>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="profileForm">
            <div class="mb-3">
              <label for="editName" class="form-label">Name</label>
              <input type="text" class="form-control" id="editName">
            </div>
            <div class="mb-3">
              <label for="editTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="editTitle">
            </div>
            <div class="mb-3">
              <label for="editBio" class="form-label">Bio</label>
              <textarea class="form-control" id="editBio" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="editEducation" class="form-label">Education</label>
              <input type="text" class="form-control" id="editEducation">
            </div>
            <div class="mb-3">
              <label for="editLocation" class="form-label">Location</label>
              <input type="text" class="form-control" id="editLocation">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveProfileChangesBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Post Modal -->
  <div class="modal fade" id="createPostModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Post</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-center py-4" id="uploadSection">
            <i class="fas fa-camera fa-4x text-muted mb-3"></i>
            <h5>Upload Photos</h5>
            <button class="btn btn-primary mt-3" id="uploadPostBtn">Select from computer</button>
            <input type="file" id="postImageInput" accept="image/*" class="d-none">
          </div>
          <div id="postPreview" class="d-none">
            <img id="postPreviewImage" src="#" class="img-fluid mb-3" alt="Preview">
            <textarea class="form-control mb-3" id="postCaption" placeholder="Write a caption..." rows="3"></textarea>
            <button class="btn btn-primary w-100" id="sharePostBtn">Share</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase UI Auth Container -->
  <div id="firebaseui-auth-container"></div>

  <!-- Hidden file inputs -->
  <input type="file" id="profileImageUpload" accept="image/*" class="d-none">
  <input type="file" id="coverImageUpload" accept="image/*" class="d-none">

  <!-- Reauthentication Modal -->
  <div class="modal fade" id="reauthModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Session Expired</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Your session has expired. Please sign in again to continue.</p>
          <div id="reauth-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase and FirebaseUI scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebaseui@6.0.2/dist/firebaseui.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAh0iCswFon37lAZG9Obr53AYLbLd1rm98",
  authDomain: "eduhub-4f629.firebaseapp.com",
  databaseURL: "https://eduhub-4f629-default-rtdb.firebaseio.com",
  projectId: "eduhub-4f629",
  storageBucket: "eduhub-4f629.appspot.com",
  messagingSenderId: "483026976450",
  appId: "1:483026976450:web:827bf2dc9c7d6858e2055b"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();

// Initialize FirebaseUI
const ui = new firebaseui.auth.AuthUI(auth);

// FirebaseUI config
const uiConfig = {
  signInSuccessUrl: '#',
  signInOptions: [
    {
      provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
      customParameters: {
        prompt: 'select_account'
      }
    },
    firebase.auth.EmailAuthProvider.PROVIDER_ID
  ],
  tosUrl: '#',
  privacyPolicyUrl: '#',
  callbacks: {
    signInSuccessWithAuthResult: function(authResult, redirectUrl) {
      handleSignedInUser(authResult.user);
      document.getElementById('firebaseui-auth-container').style.display = 'none';
      ui.reset();
      
      // Close any reauth modal if open
      const reauthModal = bootstrap.Modal.getInstance(document.getElementById('reauthModal'));
      if (reauthModal) reauthModal.hide();
      
      showToast(`Welcome, ${authResult.user.displayName || 'User'}!`);
      return false;
    },
    uiShown: function() {
      document.getElementById('loader').style.display = 'none';
    }
  },
  credentialHelper: firebaseui.auth.CredentialHelper.NONE
};

// Global user reference
let currentUser = null;
let authModal = null;
let toast = null;

// Initialize Toast
document.addEventListener('DOMContentLoaded', function() {
  toast = new bootstrap.Toast(document.getElementById('toast'));
});

// Show toast notification
function showToast(message, isError = false) {
  const toastElement = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  
  toastElement.classList.remove('bg-success', 'bg-danger');
  toastElement.classList.add(isError ? 'bg-danger' : 'bg-success');
  toastMessage.textContent = message;
  
  const bsToast = new bootstrap.Toast(toastElement);
  bsToast.show();
}

// DOM Elements
const homeBtn = document.getElementById('homeBtn');
const createBtn = document.getElementById('createBtn');
const profileBtn = document.getElementById('profileBtn');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userEmail = document.getElementById('userEmail');
const userName = document.getElementById('userName');
const userTitle = document.getElementById('userTitle');
const userBio = document.getElementById('userBio');
const userEducation = document.getElementById('userEducation');
const userLocation = document.getElementById('userLocation');
const userEmailDisplay = document.getElementById('userEmailDisplay');
const profileImage = document.getElementById('profileImage');
const coverImage = document.getElementById('coverImage');
const postCount = document.getElementById('postCount');
const followerCount = document.getElementById('followerCount');
const followingCount = document.getElementById('followingCount');
const editProfilePicBtn = document.getElementById('editProfilePicBtn');
const editCoverBtn = document.getElementById('editCoverBtn');
const profileImageUpload = document.getElementById('profileImageUpload');
const coverImageUpload = document.getElementById('coverImageUpload');
const saveProfileChangesBtn = document.getElementById('saveProfileChangesBtn');
const editName = document.getElementById('editName');
const editTitle = document.getElementById('editTitle');
const editBio = document.getElementById('editBio');
const editEducation = document.getElementById('editEducation');
const editLocation = document.getElementById('editLocation');
const postContent = document.getElementById('postContent');
const postImageUpload = document.getElementById('postImageUpload');
const uploadImageBtn = document.getElementById('uploadImageBtn');
const imageName = document.getElementById('imageName');
const postUpdateBtn = document.getElementById('postUpdateBtn');
const recentPosts = document.getElementById('recentPosts');
const allPosts = document.getElementById('allPosts');
const certificateUpload = document.getElementById('certificateUpload');
const addCertificateBtn = document.getElementById('addCertificateBtn');
const certificatesList = document.getElementById('certificatesList');
const allCertificates = document.getElementById('allCertificates');
const searchBtn = document.getElementById('searchBtn');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const feedPosts = document.getElementById('feedPosts');
const uploadPostBtn = document.getElementById('uploadPostBtn');
const postImageInput = document.getElementById('postImageInput');
const postPreview = document.getElementById('postPreview');
const postPreviewImage = document.getElementById('postPreviewImage');
const postCaption = document.getElementById('postCaption');
const sharePostBtn = document.getElementById('sharePostBtn');
const suggestionsList = document.getElementById('suggestionsList');
const storiesContainer = document.querySelector('.stories-container');
const uploadSection = document.getElementById('uploadSection');

// Initialize modals
document.addEventListener('DOMContentLoaded', function() {
  authModal = new bootstrap.Modal(document.getElementById('reauthModal'));
  
  document.getElementById('profileModal').addEventListener('shown.bs.modal', function() {
    if (!currentUser) {
      showLoginModal();
    } else {
      document.getElementById('firebaseui-auth-container').style.display = 'none';
      ui.reset();
    }
  });
});

// Auth State Observer
auth.onAuthStateChanged(function(user) {
  console.log("Auth state changed. User:", user ? user.uid : "null");
  currentUser = user;
  if (user) {
    handleSignedInUser(user);
    startTokenRefreshTimer();
    loadStories();
    loadSuggestions();
    loadFeedPosts();
  } else {
    handleSignedOutUser();
    document.getElementById('firebaseui-auth-container').style.display = 'none';
    ui.reset();
  }
}, function(error) {
  console.error("Auth state observer error:", error);
});

// Token refresh management
let tokenRefreshTimer;
function startTokenRefreshTimer() {
  if (tokenRefreshTimer) clearInterval(tokenRefreshTimer);
  
  tokenRefreshTimer = setInterval(async () => {
    try {
      if (currentUser) {
        const token = await currentUser.getIdToken(true);
        console.log('Token refreshed at', new Date().toISOString());
      }
    } catch (error) {
      console.error('Token refresh error:', error);
      if (error.code === 'auth/user-token-expired') {
        showReauthModal();
      }
    }
  }, 30 * 60 * 1000);
}

// Event Listeners
homeBtn?.addEventListener('click', showFeed);
createBtn?.addEventListener('click', () => {
  if (!currentUser) {
    showLoginModal();
  } else {
    new bootstrap.Modal(document.getElementById('createPostModal')).show();
  }
});
profileBtn?.addEventListener('click', () => {
  if (!currentUser) {
    showLoginModal();
  } else {
    new bootstrap.Modal(document.getElementById('profileModal')).show();
  }
});
loginBtn?.addEventListener('click', showLoginModal);
logoutBtn?.addEventListener('click', handleSignOut);
editProfilePicBtn?.addEventListener('click', () => profileImageUpload?.click());
editCoverBtn?.addEventListener('click', () => coverImageUpload?.click());
profileImageUpload?.addEventListener('change', uploadProfileImage);
coverImageUpload?.addEventListener('change', uploadCoverImage);
saveProfileChangesBtn?.addEventListener('click', saveProfileChanges);
uploadImageBtn?.addEventListener('click', () => postImageUpload?.click());
postImageUpload?.addEventListener('change', handlePostImageSelect);
postUpdateBtn?.addEventListener('click', createPost);
addCertificateBtn?.addEventListener('click', () => certificateUpload?.click());
certificateUpload?.addEventListener('change', uploadCertificate);
searchBtn?.addEventListener('click', searchUsers);
uploadPostBtn?.addEventListener('click', () => postImageInput?.click());
postImageInput?.addEventListener('change', handleImageSelect);
sharePostBtn?.addEventListener('click', sharePost);

function showLoginModal() {
  if (!currentUser && document.getElementById('firebaseui-auth-container').style.display !== 'flex') {
    document.getElementById('firebaseui-auth-container').style.display = 'flex';
    ui.start('#firebaseui-auth-container', uiConfig);
  }
}

function showReauthModal() {
  ui.start('#reauth-container', {
    signInOptions: [
      firebase.auth.GoogleAuthProvider.PROVIDER_ID,
      firebase.auth.EmailAuthProvider.PROVIDER_ID
    ],
    signInSuccessUrl: '#',
    callbacks: {
      signInSuccessWithAuthResult: function(authResult) {
        handleSignedInUser(authResult.user);
        authModal.hide();
        return false;
      }
    }
  });
  authModal.show();
}

async function verifyAuth() {
  if (!currentUser) {
    showLoginModal();
    return false;
  }
  
  try {
    await currentUser.getIdToken(true);
    return true;
  } catch (error) {
    console.error('Auth verification failed:', error);
    showReauthModal();
    return false;
  }
}

async function handleSignOut() {
  try {
    await auth.signOut();
    console.log("User signed out successfully");
    showToast('You have been signed out successfully');
    currentUser = null;
  } catch (error) {
    console.error('Sign out error:', error);
    showToast('Error signing out: ' + error.message, true);
  }
}

function handleSignedInUser(user) {
  console.log("Handling signed in user:", user.uid);
  document.getElementById('firebaseui-auth-container').style.display = 'none';
  ui.reset();
  
  loginBtn?.classList?.add('d-none');
  logoutBtn?.classList?.remove('d-none');
  if (userEmail) userEmail.textContent = user.email;
  updateUserProfile(user);
  loadUserData(user.uid);
  loadUserPosts(user.uid);
  loadUserCertificates(user.uid);
}

function handleSignedOutUser() {
  console.log("Handling signed out user");
  loginBtn?.classList?.remove('d-none');
  logoutBtn?.classList?.add('d-none');
  if (userEmail) userEmail.textContent = '';
  if (userName) userName.textContent = 'Guest User';
  if (userTitle) userTitle.textContent = 'Member';
  if (userBio) userBio.textContent = 'Please sign in to view your profile.';
  if (userEducation) userEducation.textContent = 'Not available';
  if (userLocation) userLocation.textContent = 'Unknown';
  if (userEmailDisplay) userEmailDisplay.textContent = 'Not signed in';
  if (profileImage) profileImage.src = 'https://via.placeholder.com/150';
  if (coverImage) coverImage.src = 'https://via.placeholder.com/1200x400';
  if (postCount) postCount.textContent = '0';
  if (followerCount) followerCount.textContent = '0';
  if (followingCount) followingCount.textContent = '0';
  
  if (recentPosts) recentPosts.innerHTML = '';
  if (allPosts) allPosts.innerHTML = '';
  if (certificatesList) certificatesList.innerHTML = '';
  if (allCertificates) allCertificates.innerHTML = '';
  
  if (feedPosts) {
    feedPosts.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-user-lock fa-4x text-muted mb-3"></i>
        <h5>Please Sign In</h5>
        <p>Sign in to view your feed and connect with others.</p>
        <button class="btn btn-primary" id="feedLoginBtn">Sign In</button>
      </div>
    `;
    document.getElementById('feedLoginBtn')?.addEventListener('click', showLoginModal);
  }
}

function updateUserProfile(user) {
  if (!user) return;
  
  if (userName) userName.textContent = user.displayName || 'User';
  if (userEmailDisplay) userEmailDisplay.textContent = user.email;
  if (user.photoURL && profileImage) profileImage.src = user.photoURL;
}

function loadUserData(userId) {
  if (!userId) return;
  
  database.ref('users/' + userId).on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      if (userName) userName.textContent = data.name || 'User';
      if (userTitle) userTitle.textContent = data.title || 'Member';
      if (userBio) userBio.textContent = data.bio || 'No bio yet.';
      if (userEducation) userEducation.textContent = data.education || 'Not specified';
      if (userLocation) userLocation.textContent = data.location || 'Unknown';
      if (postCount) postCount.textContent = data.postCount || '0';
      if (followerCount) followerCount.textContent = data.followerCount || '0';
      if (followingCount) followingCount.textContent = data.followingCount || '0';
      if (data.profileImage && profileImage) profileImage.src = data.profileImage;
      if (data.coverImage && coverImage) coverImage.src = data.coverImage;
      if (editName) editName.value = data.name || '';
      if (editTitle) editTitle.value = data.title || '';
      if (editBio) editBio.value = data.bio || '';
      if (editEducation) editEducation.value = data.education || '';
      if (editLocation) editLocation.value = data.location || '';
    } else {
      createDefaultUserData(userId);
    }
  }, (error) => {
    console.error('Database read failed:', error);
    showToast('Error loading profile data', true);
  });
}

async function createDefaultUserData(userId) {
  try {
    const user = auth.currentUser;
    const defaultData = {
      name: user?.displayName || 'User',
      email: user?.email || '',
      title: 'Member',
      bio: 'No bio yet.',
      education: 'Not specified',
      location: 'Unknown',
      postCount: 0,
      followerCount: 0,
      followingCount: 0,
      profileImage: user?.photoURL || 'https://via.placeholder.com/150',
      coverImage: 'https://via.placeholder.com/1200x400',
      createdAt: new Date().toISOString()
    };
    
    await database.ref('users/' + userId).set(defaultData);
    showToast('Profile created successfully!');
  } catch (error) {
    console.error('Error setting default data:', error);
    showToast('Error creating profile', true);
  }
}

async function uploadProfileImage(e) {
  const isAuthenticated = await verifyAuth();
  if (!isAuthenticated) return;
  
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    const userId = currentUser.uid;
    const fileExtension = file.name.split('.').pop();
    const imageRef = storage.ref(`users/${userId}/profile/profile.${fileExtension}`);
    
    if (profileImage) profileImage.src = 'https://via.placeholder.com/150?text=Uploading...';
    
    const snapshot = await imageRef.put(file);
    const url = await snapshot.ref.getDownloadURL();
    
    if (profileImage) profileImage.src = url;
    await database.ref(`users/${userId}`).update({ profileImage: url });
    
    await currentUser.updateProfile({
      photoURL: url
    });
    
    e.target.value = '';
    showToast('Profile picture updated!');
  } catch (err) {
    console.error('Upload error:', err);
    showToast('Error uploading profile image', true);
    if (profileImage) profileImage.src = 'https://via.placeholder.com/150';
  }
}

async function uploadCoverImage(e) {
  const isAuthenticated = await verifyAuth();
  if (!isAuthenticated) return;
  
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    const userId = currentUser.uid;
    const fileExtension = file.name.split('.').pop();
    const imageRef = storage.ref(`users/${userId}/cover/cover.${fileExtension}`);
    
    if (coverImage) coverImage.src = 'https://via.placeholder.com/1200x400?text=Uploading...';
    
    const snapshot = await imageRef.put(file);
    const url = await snapshot.ref.getDownloadURL();
    
    if (coverImage) coverImage.src = url;
    await database.ref(`users/${userId}`).update({ coverImage: url });
    
    e.target.value = '';
    showToast('Cover photo updated!');
  } catch (err) {
    console.error('Upload error:', err);
    showToast('Error uploading cover image', true);
    if (coverImage) coverImage.src = 'https://via.placeholder.com/1200x400';
  }
}

async function saveProfileChanges() {
  const isAuthenticated = await verifyAuth();
  if (!isAuthenticated) return;
  
  try {
    const userId = currentUser.uid;
    const updates = {
      name: editName?.value || '',
      title: editTitle?.value || '',
      bio: editBio?.value || '',
      education: editEducation?.value || '',
      location: editLocation?.value || '',
      updatedAt: new Date().toISOString()
    };
    
    await database.ref(`users/${userId}`).update(updates);
    
    if (updates.name && updates.name !== currentUser.displayName) {
      await currentUser.updateProfile({
        displayName: updates.name
      });
    }
    
    const modalElement = document.getElementById('editProfileModal');
    if (modalElement) {
      const modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) modal.hide();
    }
    
    showToast('Profile updated successfully!');
  } catch (error) {
    console.error('Profile update error:', error);
    showToast('Error updating profile', true);
  }
}

function handlePostImageSelect(e) {
  const file = e.target.files[0];
  if (file) {
    if (imageName) imageName.textContent = file.name;
  }
}

async function createPost() {
  const isAuthenticated = await verifyAuth();
  if (!isAuthenticated) return;
  
  const content = postContent?.value?.trim();
  const imageFile = postImageUpload?.files[0];
  
  if (!content && !imageFile) {
    showToast('Please add some content or an image to your post', true);
    return;
  }
  
  try {
    const userId = currentUser.uid;
    const postData = {
      content: content || '',
      authorId: userId,
      authorName: currentUser.displayName || 'User',
      authorPhoto: currentUser.photoURL || 'https://via.placeholder.com/150',
      createdAt: new Date().toISOString(),
      likes: {},
      comments: 0
    };
    
    postUpdateBtn.disabled = true;
    postUpdateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Posting...';
    
    if (imageFile) {
      const fileExtension = imageFile.name.split('.').pop();
      const imageRef = storage.ref(`posts/${userId}/${Date.now()}.${fileExtension}`);
      const snapshot = await imageRef.put(imageFile);
      const url = await snapshot.ref.getDownloadURL();
      postData.imageUrl = url;
    }
    
    const newPostRef = database.ref('posts').push();
    await newPostRef.set(postData);
    
    const userRef = database.ref(`users/${userId}`);
    const userSnapshot = await userRef.once('value');
    const currentCount = userSnapshot.val()?.postCount || 0;
    await userRef.update({ postCount: currentCount + 1 });
    
    postContent.value = '';
    postImageUpload.value = '';
    if (imageName) imageName.textContent = '';
    postUpdateBtn.disabled = false;
    postUpdateBtn.textContent = 'Post Update';
    
    showToast('Post created successfully!');
  } catch (error) {
    console.error('Error creating post:', error);
    showToast('Error creating post', true);
    postUpdateBtn.disabled = false;
    postUpdateBtn.textContent = 'Post Update';
  }
}

function loadUserPosts(userId) {
  if (!userId) return;
  
  database.ref('posts').orderByChild('authorId').equalTo(userId).on('value', (snapshot) => {
    const posts = [];
    snapshot.forEach((childSnapshot) => {
      const post = childSnapshot.val();
      post.id = childSnapshot.key;
      posts.unshift(post);
    });
    
    if (recentPosts) {
      recentPosts.innerHTML = '';
      posts.slice(0, 3).forEach(post => {
        recentPosts.appendChild(createPostElement(post, true));
      });
    }
    
    if (allPosts) {
      allPosts.innerHTML = '';
      posts.forEach(post => {
        allPosts.appendChild(createPostElement(post, false));
      });
    }
    
    if (postCount) postCount.textContent = posts.length;
  }, (error) => {
    console.error('Error loading posts:', error);
    showToast('Error loading posts', true);
  });
}

function createPostElement(post, isSmall) {
  const col = document.createElement('div');
  col.className = isSmall ? 'col-4' : 'col-md-6 col-lg-4 mb-3';
  
  const card = document.createElement('div');
  card.className = 'card h-100';
  
  let imageHtml = '';
  if (post.imageUrl) {
    imageHtml = `
      <img src="${post.imageUrl}" class="card-img-top post-image" alt="Post image" 
           style="height: ${isSmall ? '100px' : '200px'}; object-fit: cover;">
    `;
  }
  
  const date = new Date(post.createdAt).toLocaleDateString();
  const content = post.content ? `<p class="card-text">${post.content}</p>` : '';
  
  card.innerHTML = `
    ${imageHtml}
    <div class="card-body">
      ${content}
    </div>
    <div class="card-footer bg-transparent">
      <small class="text-muted">Posted on ${date}</small>
    </div>
  `;
  
  col.appendChild(card);
  return col;
}

async function uploadCertificate(e) {
  const isAuthenticated = await verifyAuth();
  if (!isAuthenticated) return;
  
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    const userId = currentUser.uid;
    const fileExtension = file.name.split('.').pop();
    const certificateRef = storage.ref(`certificates/${userId}/${Date.now()}.${fileExtension}`);
    
    addCertificateBtn.disabled = true;
    addCertificateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
    
    const snapshot = await certificateRef.put(file);
    const url = await snapshot.ref.getDownloadURL();
    
    const certificateData = {
      name: file.name,
      url: url,
      userId: userId,
      uploadedAt: new Date().toISOString()
    };
    
    const newCertificateRef = database.ref('certificates').push();
    await newCertificateRef.set(certificateData);
    
    showToast('Certificate uploaded successfully!');
    e.target.value = '';
    addCertificateBtn.disabled = false;
    addCertificateBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add Certificate';
  } catch (error) {
    console.error('Error uploading certificate:', error);
    showToast('Error uploading certificate', true);
    addCertificateBtn.disabled = false;
    addCertificateBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add Certificate';
  }
}

function loadUserCertificates(userId) {
  if (!userId) return;
  
  database.ref('certificates').orderByChild('userId').equalTo(userId).on('value', (snapshot) => {
    const certificates = [];
    snapshot.forEach((childSnapshot) => {
      const cert = childSnapshot.val();
      cert.id = childSnapshot.key;
      certificates.unshift(cert);
    });
    
    if (certificatesList) {
      certificatesList.innerHTML = '';
      certificates.slice(0, 3).forEach(cert => {
        certificatesList.appendChild(createCertificateElement(cert, true));
      });
    }
    
    if (allCertificates) {
      allCertificates.innerHTML = '';
      certificates.forEach(cert => {
        allCertificates.appendChild(createCertificateElement(cert, false));
      });
    }
  }, (error) => {
    console.error('Error loading certificates:', error);
    showToast('Error loading certificates', true);
  });
}

function createCertificateElement(cert, isSmall) {
  const col = document.createElement('div');
  col.className = isSmall ? 'col-4' : 'col-md-6 col-lg-4 mb-3';
  
  const card = document.createElement('div');
  card.className = 'card h-100 certificate-card';
  
  const date = new Date(cert.uploadedAt).toLocaleDateString();
  const fileName = cert.name.length > 20 ? cert.name.substring(0, 17) + '...' : cert.name;
  
  card.innerHTML = `
    <div class="card-body text-center">
      <i class="fas fa-certificate fa-3x text-warning mb-3"></i>
      <h6 class="card-title">${fileName}</h6>
      <small class="text-muted">Uploaded on ${date}</small>
    </div>
    <div class="card-footer bg-transparent">
      <a href="${cert.url}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
        <i class="fas fa-eye me-1"></i> View
      </a>
    </div>
  `;
  
  col.appendChild(card);
  return col;
}

function showFeed() {
  document.querySelector('.container').classList.remove('d-none');
  loadFeedPosts();
}

function loadStories() {
  if (!currentUser) return;
  
  while (storiesContainer.children.length > 1) {
    storiesContainer.removeChild(storiesContainer.lastChild);
  }

  database.ref('users').limitToFirst(10).once('value', snapshot => {
    const users = snapshot.val();
    if (users) {
      Object.keys(users).forEach(userId => {
        if (userId !== currentUser.uid) {
          const user = users[userId];
          const storyItem = document.createElement('div');
          storyItem.className = 'story-item';
          storyItem.innerHTML = `
            <div class="story-circle">
              <div class="story-inner">
                <img src="${user.profileImage || 'https://via.placeholder.com/64'}" class="img-fluid" alt="Story">
              </div>
            </div>
            <div class="story-username">${user.name || 'User'}</div>
          `;
          storiesContainer.appendChild(storyItem);
        }
      });
    }
  }, error => {
    console.error('Error loading stories:', error);
  });
}

function loadSuggestions() {
  if (!currentUser) return;
  
  suggestionsList.innerHTML = '';

  database.ref('users').limitToLast(5).once('value', snapshot => {
    const users = snapshot.val();
    if (users) {
      Object.keys(users).forEach(userId => {
        if (userId !== currentUser.uid) {
          const user = users[userId];
          const suggestionItem = document.createElement('div');
          suggestionItem.className = 'suggestion-item d-flex justify-content-between align-items-center';
          suggestionItem.innerHTML = `
            <div class="d-flex align-items-center">
              <img src="${user.profileImage || 'https://via.placeholder.com/32'}" 
                   class="rounded-circle me-3" width="32" height="32">
              <div>
                <div class="fw-bold">${user.name || 'User'}</div>
                <small class="text-muted">Suggested for you</small>
              </div>
            </div>
            <a href="#" class="text-primary">Follow</a>
          `;
          suggestionsList.appendChild(suggestionItem);
        }
      });
    }
  }, error => {
    console.error('Error loading suggestions:', error);
  });
}

function loadFeedPosts() {
  if (!currentUser) return;
  
  feedPosts.innerHTML = '<div class="spinner-container"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

  database.ref('posts').orderByChild('createdAt').limitToLast(20).once('value', snapshot => {
    const posts = snapshot.val();
    if (posts) {
      feedPosts.innerHTML = '';
      const postsArray = Object.keys(posts).map(postId => ({ ...posts[postId], id: postId }));
      postsArray.reverse().forEach(post => {
        const postElement = createFeedPostElement(post);
        feedPosts.appendChild(postElement);
      });
    } else {
      feedPosts.innerHTML = `
        <div class="text-center py-5">
          <i class="fas fa-camera fa-4x text-muted mb-3"></i>
          <h5>No Posts Yet</h5>
          <p>When you follow people, you'll see their photos here.</p>
        </div>
      `;
    }
  }, error => {
    console.error('Error loading feed:', error);
    feedPosts.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-exclamation-triangle fa-4x text-danger mb-3"></i>
        <h5>Error Loading Feed</h5>
        <p>There was a problem loading the feed. Please try again later.</p>
      </div>
    `;
  });
}

function createFeedPostElement(post) {
  const postElement = document.createElement('div');
  postElement.className = 'post-card mb-4';
  
  const date = new Date(post.createdAt).toLocaleString();
  const liked = currentUser && post.likes && post.likes[currentUser.uid];
  
  postElement.innerHTML = `
    <div class="post-header d-flex align-items-center">
      <img src="${post.authorPhoto || 'https://via.placeholder.com/32'}" 
           class="rounded-circle me-3" width="32" height="32">
      <strong>${post.authorName}</strong>
    </div>
    ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" alt="Post">` : ''}
    <div class="post-actions d-flex">
      <button class="btn btn-link text-dark me-2 like-btn" data-postid="${post.id}">
        <i class="${liked ? 'fas' : 'far'} fa-heart fa-lg ${liked ? 'text-danger' : ''}"></i>
      </button>
      <button class="btn btn-link text-dark me-2">
        <i class="far fa-comment fa-lg"></i>
      </button>
      <button class="btn btn-link text-dark">
        <i class="far fa-paper-plane fa-lg"></i>
      </button>
      <button class="btn btn-link text-dark ms-auto">
        <i class="far fa-bookmark fa-lg"></i>
      </button>
    </div>
    <div class="post-likes">
      ${post.likes ? Object.keys(post.likes).length : 0} likes
    </div>
    <div class="post-caption">
      <strong>${post.authorName}</strong> ${post.content || ''}
    </div>
    <div class="post-comments">
      View all ${post.comments || 0} comments
    </div>
    <div class="post-time">
      ${date}
    </div>
  `;
  
  const likeBtn = postElement.querySelector('.like-btn');
  likeBtn.addEventListener('click', () => toggleLike(post.id));
  
  return postElement;
}

async function toggleLike(postId) {
  if (!currentUser) {
    showLoginModal();
    return;
  }
  
  try {
    const likeRef = database.ref(`posts/${postId}/likes/${currentUser.uid}`);
    const snapshot = await likeRef.once('value');
    
    if (snapshot.exists()) {
      await likeRef.remove();
    } else {
      await likeRef.set(true);
    }
  } catch (error) {
    console.error('Error toggling like:', error);
    showToast('Error liking post', true);
  }
}

function searchUsers() {
  const searchTerm = searchInput.value.trim().toLowerCase();
  if (!searchTerm) {
    searchResults.innerHTML = '';
    return;
  }

  database.ref('users').once('value', snapshot => {
    const users = snapshot.val();
    searchResults.innerHTML = '';
    
    if (users) {
      Object.keys(users).forEach(userId => {
        const user = users[userId];
        const userName = user.name?.toLowerCase() || '';
        const userEmail = user.email?.toLowerCase() || '';
        
        if (userName.includes(searchTerm) || userEmail.includes(searchTerm)) {
          const isCurrentUser = userId === currentUser?.uid;
          const userElement = document.createElement('div');
          userElement.className = 'd-flex align-items-center mb-3';
          userElement.innerHTML = `
            <img src="${user.profileImage || 'https://via.placeholder.com/44'}" 
                 class="rounded-circle me-3" width="44" height="44">
            <div>
              <div class="fw-bold">${user.name || 'User'}</div>
              <small class="text-muted">${user.email || ''}</small>
            </div>
            ${!isCurrentUser ? `<a href="#" class="btn btn-primary btn-sm ms-auto follow-btn" data-userid="${userId}">Follow</a>` : ''}
          `;
          searchResults.appendChild(userElement);
          
          if (!isCurrentUser) {
            const followBtn = userElement.querySelector('.follow-btn');
            followBtn.addEventListener('click', (e) => {
              e.preventDefault();
              followUser(userId);
            });
          }
        }
      });
      
      if (searchResults.children.length === 0) {
        searchResults.innerHTML = '<div class="text-muted">No users found</div>';
      }
    }
  }, error => {
    console.error('Error searching users:', error);
    searchResults.innerHTML = '<div class="text-danger">Error searching users</div>';
  });
}

async function followUser(userId) {
  if (!currentUser) {
    showLoginModal();
    return;
  }
  
  try {
    const followRef = database.ref(`following/${currentUser.uid}/${userId}`);
    const snapshot = await followRef.once('value');
    
    if (snapshot.exists()) {
      await followRef.remove();
      await database.ref(`followers/${userId}/${currentUser.uid}`).remove();
      showToast('You have unfollowed this user');
    } else {
      await followRef.set(true);
      await database.ref(`followers/${userId}/${currentUser.uid}`).set(true);
      showToast('You are now following this user');
    }
    
    const followBtn = document.querySelector(`.follow-btn[data-userid="${userId}"]`);
    if (followBtn) {
      followBtn.textContent = snapshot.exists() ? 'Follow' : 'Following';
      followBtn.classList.toggle('btn-primary');
      followBtn.classList.toggle('btn-secondary');
    }
  } catch (error) {
    console.error('Error following user:', error);
    showToast('Error following user', true);
  }
}

function handleImageSelect(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      postPreviewImage.src = event.target.result;
      postPreview.classList.remove('d-none');
      uploadSection.classList.add('d-none');
    };
    reader.readAsDataURL(file);
  }
}

async function sharePost() {
  if (!currentUser) {
    showLoginModal();
    return;
  }
  
  if (!postImageInput.files[0]) {
    showToast('Please select an image to post', true);
    return;
  }
  
  const file = postImageInput.files[0];
  const fileExtension = file.name.split('.').pop();
  const storageRef = storage.ref(`posts/${currentUser.uid}/${Date.now()}.${fileExtension}`);
  
  sharePostBtn.disabled = true;
  sharePostBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sharing...';
  
  try {
    const snapshot = await storageRef.put(file);
    const url = await snapshot.ref.getDownloadURL();
    
    const postData = {
      authorId: currentUser.uid,
      authorName: currentUser.displayName || 'User',
      authorPhoto: currentUser.photoURL || 'https://via.placeholder.com/150',
      imageUrl: url,
      content: postCaption.value.trim(),
      likes: {},
      comments: 0,
      createdAt: new Date().toISOString()
    };
    
    const newPostRef = await database.ref('posts').push(postData);
    
    const userRef = database.ref(`users/${currentUser.uid}`);
    const userSnapshot = await userRef.once('value');
    const currentCount = userSnapshot.val()?.postCount || 0;
    await userRef.update({ postCount: currentCount + 1 });
    
    postImageInput.value = '';
    postCaption.value = '';
    postPreview.classList.add('d-none');
    uploadSection.classList.remove('d-none');
    sharePostBtn.disabled = false;
    sharePostBtn.textContent = 'Share';
    
    const modalElement = document.getElementById('createPostModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    modal.hide();
    
    showToast('Post shared successfully!');
  } catch (error) {
    console.error('Error sharing post:', error);
    showToast('Error sharing post', true);
    sharePostBtn.disabled = false;
    sharePostBtn.textContent = 'Share';
  }
}

// Initialize real-time listeners
document.addEventListener('DOMContentLoaded', () => {
  database.ref('posts').on('child_changed', snapshot => {
    const post = snapshot.val();
    const postId = snapshot.key;
    
    const likesElement = document.querySelector(`[data-postid="${postId}"] .post-likes`);
    if (likesElement) {
      const likeCount = post.likes ? Object.keys(post.likes).length : 0;
      likesElement.textContent = `${likeCount} likes`;
    }
    
    if (currentUser) {
      const likeBtn = document.querySelector(`[data-postid="${postId}"] .like-btn i`);
      if (likeBtn) {
        const liked = post.likes && post.likes[currentUser.uid];
        likeBtn.className = `${liked ? 'fas' : 'far'} fa-heart fa-lg ${liked ? 'text-danger' : ''}`;
      }
    }
  });
  
  database.ref('posts').orderByChild('createdAt').limitToLast(1).on('child_added', snapshot => {
    const post = snapshot.val();
    post.id = snapshot.key;
    
    if (!document.querySelector(`[data-postid="${post.id}"]`)) {
      const postElement = createFeedPostElement(post);
      if (feedPosts.firstChild?.classList?.contains('spinner-container')) {
        feedPosts.innerHTML = '';
      }
      feedPosts.insertBefore(postElement, feedPosts.firstChild);
    }
  });
});
        
  </script>
</body>
</html>
